<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>VivusFisio Plan - Sistema de Gestão</title>
    <link href="https://fonts.googleapis.com" rel="preconnect"/>
    <link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect"/>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700;800&display=swap" rel="stylesheet"/>
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <script id="tailwind-config">
        tailwind.config = {
          darkMode: "class",
          theme: {
            extend: {
              colors: {
                "primary": "#111827",
                "secondary": "#6b7280",
                "background-light": "#f9fafb",
                "background-dark": "#1f2937",
                "card-light": "#ffffff",
                "card-dark": "#374151"
              },
              fontFamily: {
                "display": ["Inter", "sans-serif"]
              },
              borderRadius: {
                "DEFAULT": "0.5rem",
                "lg": "1rem",
                "xl": "1.5rem",
                "full": "9999px"
              },
            },
          },
        }
    </script>
    <style>
        body {
          box-sizing: border-box;
          min-height: max(884px, 100dvh);
          font-family: 'Inter', sans-serif;
        }
        .page { display: none; }
        .page.active { display: block; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .tab-button.active { background-color: #111827; color: white; }
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #111827;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-background-light dark:bg-background-dark font-display">
    <!-- LOGIN PAGE -->
    <div id="loginPage" class="page active">
        <div class="flex flex-col min-h-screen">
            <main class="flex-grow flex flex-col justify-center items-center px-6">
                <div class="w-full max-w-sm mx-auto flex flex-col items-center">
                    <div class="mb-6">
                        <div class="w-14 h-14 rounded-full flex items-center justify-center text-white text-2xl font-bold shadow-lg overflow-hidden" id="logoContainer">
                            <img 
                                src="images/vivuslogo.png" 
                                alt="Vivusfisio Logo" 
                                class="w-full h-full object-cover"
                                onload="document.getElementById('logoContainer').classList.remove('bg-primary');"
                                onerror="this.style.display='none'; this.nextElementSibling.style.display='flex'; document.getElementById('logoContainer').classList.add('bg-primary');"
                            >
                            <span class="w-full h-full flex items-center justify-center bg-primary rounded-full" style="display: none;">VF</span>
                        </div>
                    </div>
                    <h1 class="text-3xl font-bold text-primary dark:text-white tracking-tighter mb-2">Vivusfisio Plano</h1>
                    <p class="text-sm text-secondary dark:text-gray-400 mb-6">Código de Acesso</p>
                    
                    <form id="loginForm" class="w-full space-y-4">
                        <div class="flex flex-col">
                            <label class="sr-only" for="accessCode">Código único de acesso</label>
                            <input 
                                class="form-input w-full bg-card-light dark:bg-card-dark border-2 border-gray-200 dark:border-gray-600 rounded-lg h-14 px-4 text-center text-xl tracking-[0.1em] font-bold text-primary dark:text-white placeholder:text-gray-400 focus:ring-2 focus:ring-primary/50 focus:border-primary transition-colors duration-300" 
                                id="accessCode" 
                                maxlength="12" 
                                placeholder="●●●●●●●●●●●●" 
                                type="text"
                                required
                            />
                        </div>
                        <button 
                            type="submit" 
                            id="loginButton"
                            class="w-full h-14 bg-primary text-white font-bold text-lg rounded-lg shadow-lg hover:bg-opacity-90 transition-opacity"
                        >
                            <span id="loginText">Entrar</span>
                            <span id="loginLoading" class="loading" style="display: none;"></span>
                        </button>
                    </form>

                    <div id="loginError" class="mt-4 p-3 bg-red-50 border border-red-200 rounded-lg text-red-700 text-sm w-full" style="display: none;">
                        <strong>Erro:</strong> <span id="errorMessage"></span>
                    </div>

                    <div class="mt-6 text-center">
                        <p class="text-xs text-secondary dark:text-gray-400">
                            Não tem código? Entre em contato com o administrador.
                        </p>
                        <p class="text-xs text-gray-400 mt-2">
                            Versão 1.3.0 - Filtros e Permissões
                        </p>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- MAIN APP -->
    <div id="mainApp" class="page">
        <!-- Header -->
        <header class="flex items-center justify-between p-4">
            <!-- User Profile in Header Left -->
            <div class="flex items-center space-x-2 text-primary dark:text-white">
                <div class="w-8 h-8 rounded-full bg-primary text-white flex items-center justify-center text-sm font-bold" id="headerUserInitials">
                    VF
                </div>
                <div class="text-left">
                    <div class="text-sm font-medium" id="headerUserName">Usuário</div>
                    <div class="text-xs text-secondary dark:text-gray-400" id="headerUserType">Tipo</div>
                </div>
            </div>
            
            <!-- Menu Button -->
            <button onclick="toggleSideMenu()" class="text-primary dark:text-white hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg p-2 transition-colors">
                <svg class="h-6 w-6" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M4 6h16M4 12h16M4 18h16"></path>
                </svg>
            </button>
        </header>

        <!-- Side Menu Overlay -->
        <div id="sideMenuOverlay" class="fixed inset-0 bg-black bg-opacity-50 z-40 hidden" onclick="closeSideMenu()"></div>

        <!-- Side Menu -->
        <div id="sideMenu" class="fixed top-0 right-0 h-full w-80 bg-card-light dark:bg-card-dark shadow-xl z-50 transform translate-x-full transition-transform duration-300">
            <div class="p-4 border-b border-gray-200 dark:border-gray-700">
                <div class="flex items-center justify-between">
                    <h2 class="text-lg font-bold text-primary dark:text-white">Menu</h2>
                    <button onclick="closeSideMenu()" class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
            </div>
            
            <div class="p-4 space-y-4">
                <!-- User Info -->
                <div class="flex items-center space-x-3 p-3 bg-gray-50 dark:bg-gray-800 rounded-lg">
                    <div class="w-12 h-12 rounded-full bg-primary text-white flex items-center justify-center font-bold" id="sideMenuUserInitials">
                        VF
                    </div>
                    <div>
                        <div class="font-medium text-primary dark:text-white" id="sideMenuUserName">Usuário</div>
                        <div class="text-sm text-secondary dark:text-gray-400" id="sideMenuUserType">Tipo</div>
                    </div>
                </div>

                <!-- Menu Items -->
                <div class="space-y-2">
                    <!-- Dashboard -->
                    <button onclick="goToDashboard()" class="w-full flex items-center space-x-3 p-3 text-left hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg transition-colors">
                        <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2H5a2 2 0 00-2-2z"></path>
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 5a2 2 0 012-2h4a2 2 0 012 2v6H8V5z"></path>
                        </svg>
                        <span class="text-primary dark:text-white">Dashboard</span>
                    </button>

                    <!-- All Plans -->
                    <button onclick="showAllPlans()" class="w-full flex items-center space-x-3 p-3 text-left hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg transition-colors">
                        <svg class="w-5 h-5 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                        </svg>
                        <span class="text-primary dark:text-white">Todos os Planos</span>
                    </button>

                    <!-- User Management (Master only) -->
                    <button id="userManagementMenuItem" onclick="showUserManagement()" class="w-full flex items-center space-x-3 p-3 text-left hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg transition-colors" style="display: none;">
                        <svg class="w-5 h-5 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197m13.5-9a2.5 2.5 0 11-5 0 2.5 2.5 0 015 0z"></path>
                        </svg>
                        <span class="text-primary dark:text-white">Gestão de Utilizadores</span>
                    </button>

                    <!-- Divider -->
                    <div class="border-t border-gray-200 dark:border-gray-700 my-4"></div>

                    <!-- Logout -->
                    <button onclick="logout()" class="w-full flex items-center space-x-3 p-3 text-left hover:bg-red-50 dark:hover:bg-red-900/20 rounded-lg transition-colors text-red-600 dark:text-red-400">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path>
                        </svg>
                        <span>Sair</span>
                    </button>
                </div>

                <!-- Version Info in Menu -->
                <div class="mt-8 pt-4 border-t border-gray-200 dark:border-gray-700">
                    <div class="text-center">
                        <p class="text-xs text-gray-400">VivusFisio Plan</p>
                        <p class="text-xs text-gray-500">v1.3.0 - Filtros e Permissões</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Navigation Tabs -->
        <nav id="navigationTabs" class="bg-card-light dark:bg-card-dark border-b border-gray-200 dark:border-gray-700 sticky top-0 z-10">
            <div class="px-4">
                <div class="flex space-x-1 overflow-x-auto" id="tabContainer">
                    <!-- Tabs will be dynamically added based on user type -->
                </div>
            </div>
        </nav>

        <main class="p-4 space-y-8 pb-24 bg-background-light dark:bg-background-dark min-h-screen">

            <!-- Master UI Tab -->
            <div id="master" class="tab-content active space-y-8">

                <!-- Planos em aprovação -->
                <section>
                    <button onclick="toggleSection('pendingPlans')" class="w-full flex items-center justify-between text-left mb-4 hover:bg-gray-50 dark:hover:bg-gray-800 p-2 rounded-lg transition-colors">
                        <h3 class="text-xl font-bold text-primary dark:text-white">Planos em aprovação <span class="text-sm font-normal text-gray-500 dark:text-gray-400">(2)</span></h3>
                        <svg id="pendingPlansIcon" class="w-5 h-5 text-primary dark:text-white transform transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                        </svg>
                    </button>
                    <div id="pendingPlans" class="space-y-3" style="display: block;">
                        <div class="flex items-center gap-4 rounded-lg bg-card-light dark:bg-card-dark p-3 shadow-sm border border-gray-200 dark:border-gray-700">
                            <div class="flex h-12 w-12 shrink-0 items-center justify-center rounded-lg bg-blue-100 dark:bg-blue-900/50 text-blue-600 dark:text-blue-400">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                    <path d="M12 6v6l4 2" stroke-linecap="round" stroke-linejoin="round"></path>
                                    <path d="M12 22c5.523 0 10-4.477 10-10S17.523 2 12 2 2 6.477 2 12s4.477 10 10 10z" stroke-linecap="round" stroke-linejoin="round"></path>
                                </svg>
                            </div>
                            <div class="flex-1">
                                <p class="font-semibold text-primary dark:text-white">Plano de Reabilitação de Ombro</p>
                                <p class="text-sm text-secondary dark:text-gray-400">Paciente: Carlos Pereira</p>
                            </div>
                        </div>
                        
                        <div class="flex items-center gap-4 rounded-lg bg-card-light dark:bg-card-dark p-3 shadow-sm border border-gray-200 dark:border-gray-700">
                            <div class="flex h-12 w-12 shrink-0 items-center justify-center rounded-lg bg-blue-100 dark:bg-blue-900/50 text-blue-600 dark:text-blue-400">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                    <path d="M12 6v6l4 2" stroke-linecap="round" stroke-linejoin="round"></path>
                                    <path d="M12 22c5.523 0 10-4.477 10-10S17.523 2 12 2 2 6.477 2 12s4.477 10 10 10z" stroke-linecap="round" stroke-linejoin="round"></path>
                                </svg>
                            </div>
                            <div class="flex-1">
                                <p class="font-semibold text-primary dark:text-white">Plano de Fortalecimento Lombar</p>
                                <p class="text-sm text-secondary dark:text-gray-400">Paciente: Ana Costa</p>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Planos Abertos -->
                <section>
                    <button onclick="toggleSection('activePlans')" class="w-full flex items-center justify-between text-left mb-4 hover:bg-gray-50 dark:hover:bg-gray-800 p-2 rounded-lg transition-colors">
                        <h3 class="text-xl font-bold text-primary dark:text-white">Planos Abertos <span id="activePlansCount" class="text-sm font-normal text-gray-500 dark:text-gray-400">(0)</span></h3>
                        <svg id="activePlansIcon" class="w-5 h-5 text-primary dark:text-white transform transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                        </svg>
                    </button>
                    <div id="activePlans" class="space-y-3" style="display: block;">
                        <div class="text-center text-gray-500 py-4">
                            <div class="loading mx-auto mb-2"></div>
                            <div class="text-sm">Carregando planos...</div>
                        </div>
                    </div>
                </section>

                <!-- Sessões Realizadas -->
                <section>
                    <button onclick="toggleSection('completedSessions')" class="w-full flex items-center justify-between text-left mb-4 hover:bg-gray-50 dark:hover:bg-gray-800 p-2 rounded-lg transition-colors">
                        <h3 class="text-xl font-bold text-primary dark:text-white">Sessões Realizadas <span id="completedSessionsCount" class="text-sm font-normal text-gray-500 dark:text-gray-400">(0)</span></h3>
                        <svg id="completedSessionsIcon" class="w-5 h-5 text-primary dark:text-white transform transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                        </svg>
                    </button>
                    <div id="completedSessions" class="space-y-3" style="display: block;">
                        <div class="text-center text-gray-500 py-4">
                            <div class="loading mx-auto mb-2"></div>
                            <div class="text-sm">Carregando sessões...</div>
                        </div>
                    </div>
                </section>
            </div>
        </main>
    </div>

    <script>
        // Basic functionality to make the interface work
        function toggleSideMenu() {
            const sideMenu = document.getElementById('sideMenu');
            const overlay = document.getElementById('sideMenuOverlay');
            
            sideMenu.classList.toggle('translate-x-full');
            overlay.classList.toggle('hidden');
        }

        function closeSideMenu() {
            const sideMenu = document.getElementById('sideMenu');
            const overlay = document.getElementById('sideMenuOverlay');
            
            sideMenu.classList.add('translate-x-full');
            overlay.classList.add('hidden');
        }

        function toggleSection(sectionId) {
            const section = document.getElementById(sectionId);
            const icon = document.getElementById(sectionId + 'Icon');
            
            // Check if section is currently hidden
            const isHidden = section.style.display === 'none';
            
            if (isHidden) {
                section.style.display = 'block';
                icon.classList.remove('rotate-180');
            } else {
                section.style.display = 'none';
                icon.classList.add('rotate-180');
            }
        }

        function goToDashboard() {
            closeSideMenu();
            // Dashboard functionality would go here
        }

        function showAllPlans() {
            closeSideMenu();
            // All plans functionality would go here
        }

        function showUserManagement() {
            closeSideMenu();
            // User management functionality would go here
        }

        function logout() {
            // Close side menu first
            closeSideMenu();
            
            // Clear user session data
            sessionStorage.removeItem('currentUser');
            
            // Reset login form
            document.getElementById('accessCode').value = '';
            document.getElementById('loginError').style.display = 'none';
            
            // Switch back to login page
            document.getElementById('mainApp').classList.remove('active');
            document.getElementById('loginPage').classList.add('active');
        }

        // Helper function to parse date and time
        function parseDateTime(dateStr, timeStr) {
            if (!dateStr || !timeStr) return null;
            
            try {
                // Handle different date formats
                let formattedDate = dateStr;
                if (dateStr.includes('/')) {
                    // Convert DD/MM/YYYY to YYYY-MM-DD
                    const parts = dateStr.split('/');
                    if (parts.length === 3) {
                        formattedDate = `${parts[2]}-${parts[1].padStart(2, '0')}-${parts[0].padStart(2, '0')}`;
                    }
                }
                
                // Handle time format (ensure HH:MM)
                let formattedTime = timeStr;
                if (timeStr.length === 4 && !timeStr.includes(':')) {
                    // Convert HHMM to HH:MM
                    formattedTime = `${timeStr.substring(0, 2)}:${timeStr.substring(2)}`;
                }
                
                const dateTimeStr = `${formattedDate}T${formattedTime}:00`;
                const dateTime = new Date(dateTimeStr);
                
                return isNaN(dateTime.getTime()) ? null : dateTime;
            } catch (error) {
                console.error('Error parsing date/time:', error);
                return null;
            }
        }

        // Check if user is master
        function isMasterUser() {
            const currentUser = JSON.parse(sessionStorage.getItem('currentUser') || '{}');
            const userSpecialty = currentUser.specialty || '';
            const userType = currentUser.type || '';
            const isMaster = userSpecialty.toLowerCase().includes('master') || userType.toLowerCase().includes('master') || userType.toLowerCase().includes('admin');
            console.log(`🔍 Verificando se é master: Especialidade="${userSpecialty}", Tipo="${userType}" -> ${isMaster}`);
            return isMaster;
        }

        // Get current user name for filtering
        function getCurrentUserName() {
            const currentUser = JSON.parse(sessionStorage.getItem('currentUser') || '{}');
            return currentUser.name || '';
        }

        // Steinhq API functions with improved error handling and filtering
        async function loadActivePlans() {
            const activePlansContainer = document.getElementById('activePlans');
            const activePlansCount = document.getElementById('activePlansCount');
            
            try {
                console.log('🔄 Iniciando carregamento de planos ativos...');
                console.log('🔑 Storage ID: 68d29050affba40a62ffb0f6');
                
                // First, try to get the main sheet without guessing names
                const baseUrl = 'https://api.steinhq.com/v1/storages/68d29050affba40a62ffb0f6';
                
                // Try the correct sheet names first
                const possibleSheetNames = ['planos', 'planos_ativos', 'Sheet1', 'Planilha1', 'PlanosAtivos'];
                let data = [];
                let successfulSheet = null;
                
                for (const sheetName of possibleSheetNames) {
                    try {
                        console.log(`🔍 Testando sheet: ${sheetName}`);
                        const url = `${baseUrl}/${sheetName}`;
                        
                        const response = await fetch(url, {
                            method: 'GET',
                            headers: {
                                'Accept': 'application/json'
                            }
                        });
                        
                        console.log(`📡 Status ${sheetName}: ${response.status}`);
                        
                        if (response.status === 200) {
                            const rawData = await response.text();
                            console.log(`📄 Dados recebidos de ${sheetName}:`, rawData.length, 'caracteres');
                            
                            if (rawData && rawData.trim() !== '') {
                                try {
                                    const parsedData = JSON.parse(rawData);
                                    console.log(`📊 Dados parseados de ${sheetName}:`, parsedData);
                                    
                                    if (Array.isArray(parsedData) && parsedData.length > 0) {
                                        // Check if it has valid data (not just empty objects)
                                        const validData = parsedData.filter(item => 
                                            item && typeof item === 'object' && Object.keys(item).length > 0
                                        );
                                        
                                        if (validData.length > 0) {
                                            data = validData;
                                            successfulSheet = sheetName;
                                            console.log(`✅ Dados válidos encontrados em ${sheetName}:`, data.length, 'registros');
                                            console.log('🔍 Primeira linha:', data[0]);
                                            break;
                                        }
                                    }
                                } catch (parseError) {
                                    console.error(`❌ Erro JSON em ${sheetName}:`, parseError);
                                }
                            }
                        } else if (response.status === 400) {
                            console.warn(`⚠️ Sheet ${sheetName} não existe (400)`);
                        } else {
                            console.warn(`⚠️ Erro ${response.status} para ${sheetName}`);
                        }
                    } catch (sheetError) {
                        console.error(`❌ Erro de rede para ${sheetName}:`, sheetError.message);
                    }
                    
                    // Small delay between requests
                    await new Promise(resolve => setTimeout(resolve, 100));
                }
                
                // Process data if found
                if (data && data.length > 0) {
                    console.log(`🎉 Processando ${data.length} planos do sheet ${successfulSheet}`);
                    console.log('📋 Colunas disponíveis:', Object.keys(data[0]));
                    
                    // Filter data based on user permissions
                    const isMaster = isMasterUser();
                    let filteredData;
                    
                    if (isMaster) {
                        // Master sees ALL data without any filters
                        filteredData = data;
                        console.log(`👑 MASTER USER DETECTADO - Mostrando TODOS os ${filteredData.length} planos (SEM FILTROS)`);
                    } else {
                        // Regular users see only their own data
                        const currentUserName = getCurrentUserName();
                        filteredData = data.filter(plan => {
                            const physiotherapist = plan.fisioterapeuta || plan.physiotherapist || plan.terapeuta || plan.therapist || '';
                            return physiotherapist.toLowerCase().includes(currentUserName.toLowerCase());
                        });
                        console.log(`🔒 Utilizador normal - Dados filtrados para ${currentUserName}: ${filteredData.length} registros`);
                    }
                    
                    activePlansContainer.innerHTML = '';
                    filteredData.forEach((plan, index) => {
                        // Handle different possible column names
                        const planName = plan.nome || plan.plano || plan.name || plan.plan_name || plan.titulo || `Plano ${index + 1}`;
                        const patientName = plan.paciente || plan.patient || plan.cliente || plan.client || 'Paciente não informado';
                        const sessionsLeft = plan.sessoes_restantes || plan.sessoes || plan.sessions || plan.remaining_sessions || '0';
                        
                        console.log(`📋 Plano ${index + 1}: ${planName} - ${patientName} - ${sessionsLeft} sessões`);
                        
                        // Get service, date and physiotherapist information
                        const serviceName = plan.servico || plan.service || plan.tipo || plan.type || 'Serviço não informado';
                        const sessionDate = plan.datasessao || plan.data_sessao || plan.session_date || plan.data || plan.date || 'Data não informada';
                        const physiotherapist = plan.fisioterapeuta || plan.physiotherapist || plan.terapeuta || plan.therapist || 'Fisioterapeuta não informado';
                        
                        const planElement = document.createElement('div');
                        planElement.className = 'flex items-center gap-4 rounded-lg bg-card-light dark:bg-card-dark p-3 shadow-sm border border-gray-200 dark:border-gray-700';
                        planElement.innerHTML = `
                            <div class="flex h-12 w-12 shrink-0 items-center justify-center rounded-lg bg-yellow-100 dark:bg-yellow-900/50 text-yellow-600 dark:text-yellow-400">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24">
                                    <path d="M9 12h3.75M9 15h3.75M9 18h3.75m3 .75H18a2.25 2.25 0 002.25-2.25V6.108c0-1.135-.845-2.098-1.976-2.192a48.424 48.424 0 00-1.123-.08m-5.801 0c-.065.21-.1.433-.1.664 0 .414.336.75.75.75h4.5a.75.75 0 00.75-.75 2.25 2.25 0 00-.1-.664m-5.8 0A2.251 2.251 0 0113.5 2.25H15c1.012 0 1.867.668 2.15 1.586m-5.8 0c-.376.023-.75.05-1.124.08C9.095 4.01 8.25 4.973 8.25 6.108V8.25m0 0H4.875c-.621 0-1.125.504-1.125 1.125v11.25c0 .621.504 1.125 1.125 1.125h9.75c.621 0 1.125-.504 1.125-1.125V9.375c0-.621-.504-1.125-1.125-1.125H8.25zM6.75 12h.008v.008H6.75V12zm0 3h.008v.008H6.75V15zm0 3h.008v.008H6.75V18z" stroke-linecap="round" stroke-linejoin="round"></path>
                                </svg>
                            </div>
                            <div class="flex-1">
                                <p class="font-semibold text-primary dark:text-white">${planName} - ${sessionDate}</p>
                                <p class="text-sm text-secondary dark:text-gray-400">${serviceName}</p>
                                <p class="text-xs text-yellow-600 dark:text-yellow-400">Fisioterapeuta: ${physiotherapist}</p>
                            </div>
                        `;
                        activePlansContainer.appendChild(planElement);
                    });
                    activePlansCount.textContent = `(${filteredData.length})`;
                } else {
                    console.log('📝 Nenhum dado válido encontrado, usando dados de exemplo');
                    loadActivePlansFromFallback();
                }
                
            } catch (error) {
                console.error('❌ Erro geral:', error);
                loadActivePlansFromFallback();
            }
        }

        function loadActivePlansFromFallback() {
            const fallbackData = [
                {
                    nome: "Maria Silva",
                    datasessao: "2024-01-20",
                    servico: "Fisioterapia Ortopédica",
                    fisioterapeuta: "Dr. Carlos Mendes"
                },
                {
                    nome: "João Santos", 
                    datasessao: "2024-01-21",
                    servico: "Fisioterapia Respiratória",
                    fisioterapeuta: "Dra. Ana Pereira"
                },
                {
                    nome: "Pedro Oliveira",
                    datasessao: "2024-01-22",
                    servico: "Fortalecimento Muscular",
                    fisioterapeuta: "Dr. Luis Costa"
                }
            ];

            // Filter fallback data based on user permissions
            let filteredFallbackData = fallbackData;
            const isMaster = isMasterUser();
            
            if (isMaster) {
                // Master sees ALL fallback data
                filteredFallbackData = fallbackData;
                console.log(`👑 MASTER USER - Mostrando todos os ${filteredFallbackData.length} planos de exemplo (sem filtros)`);
            } else {
                // Regular users see filtered data
                const currentUserName = getCurrentUserName();
                filteredFallbackData = fallbackData.filter(plan => {
                    return plan.fisioterapeuta.toLowerCase().includes(currentUserName.toLowerCase());
                });
                console.log(`🔒 Utilizador normal - Planos de exemplo filtrados: ${filteredFallbackData.length}`);
            }

            const activePlansContainer = document.getElementById('activePlans');
            const activePlansCount = document.getElementById('activePlansCount');
            
            activePlansContainer.innerHTML = '';
            filteredFallbackData.forEach(plan => {
                const planElement = document.createElement('div');
                planElement.className = 'flex items-center gap-4 rounded-lg bg-card-light dark:bg-card-dark p-3 shadow-sm border border-gray-200 dark:border-gray-700';
                planElement.innerHTML = `
                    <div class="flex h-12 w-12 shrink-0 items-center justify-center rounded-lg bg-yellow-100 dark:bg-yellow-900/50 text-yellow-600 dark:text-yellow-400">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24">
                            <path d="M9 12h3.75M9 15h3.75M9 18h3.75m3 .75H18a2.25 2.25 0 002.25-2.25V6.108c0-1.135-.845-2.098-1.976-2.192a48.424 48.424 0 00-1.123-.08m-5.801 0c-.065.21-.1.433-.1.664 0 .414.336.75.75.75h4.5a.75.75 0 00.75-.75 2.25 2.25 0 00-.1-.664m-5.8 0A2.251 2.251 0 0113.5 2.25H15c1.012 0 1.867.668 2.15 1.586m-5.8 0c-.376.023-.75.05-1.124.08C9.095 4.01 8.25 4.973 8.25 6.108V8.25m0 0H4.875c-.621 0-1.125.504-1.125 1.125v11.25c0 .621.504 1.125 1.125 1.125h9.75c.621 0 1.125-.504 1.125-1.125V9.375c0-.621-.504-1.125-1.125-1.125H8.25zM6.75 12h.008v.008H6.75V12zm0 3h.008v.008H6.75V15zm0 3h.008v.008H6.75V18z" stroke-linecap="round" stroke-linejoin="round"></path>
                        </svg>
                    </div>
                    <div class="flex-1">
                        <p class="font-semibold text-primary dark:text-white">${plan.nome} - ${plan.datasessao}</p>
                        <p class="text-sm text-secondary dark:text-gray-400">${plan.servico}</p>
                        <p class="text-xs text-yellow-600 dark:text-yellow-400">Fisioterapeuta: ${plan.fisioterapeuta}</p>
                    </div>
                `;
                activePlansContainer.appendChild(planElement);
            });
            activePlansCount.textContent = `(${filteredFallbackData.length})`;
        }

        async function loadCompletedSessions() {
            const completedSessionsContainer = document.getElementById('completedSessions');
            const completedSessionsCount = document.getElementById('completedSessionsCount');
            
            try {
                console.log('🔄 Iniciando carregamento de sessões realizadas...');
                console.log('🔑 Storage ID: 68d29050affba40a62ffb0f6');
                
                const baseUrl = 'https://api.steinhq.com/v1/storages/68d29050affba40a62ffb0f6';
                
                // Try the correct sheet names for sessions
                const possibleSheetNames = ['sessoes', 'sessoes_realizadas', 'Sheet2', 'Planilha2', 'SessoesRealizadas'];
                let data = [];
                let successfulSheet = null;
                
                for (const sheetName of possibleSheetNames) {
                    try {
                        console.log(`🔍 Testando sheet de sessões: ${sheetName}`);
                        const url = `${baseUrl}/${sheetName}`;
                        
                        const response = await fetch(url, {
                            method: 'GET',
                            headers: {
                                'Accept': 'application/json'
                            }
                        });
                        
                        console.log(`📡 Status ${sheetName}: ${response.status}`);
                        
                        if (response.status === 200) {
                            const rawData = await response.text();
                            console.log(`📄 Dados recebidos de ${sheetName}:`, rawData.length, 'caracteres');
                            
                            if (rawData && rawData.trim() !== '') {
                                try {
                                    const parsedData = JSON.parse(rawData);
                                    console.log(`📊 Dados parseados de ${sheetName}:`, parsedData);
                                    
                                    if (Array.isArray(parsedData) && parsedData.length > 0) {
                                        // Check if it has valid data (not just empty objects)
                                        const validData = parsedData.filter(item => 
                                            item && typeof item === 'object' && Object.keys(item).length > 0
                                        );
                                        
                                        if (validData.length > 0) {
                                            data = validData;
                                            successfulSheet = sheetName;
                                            console.log(`✅ Dados válidos de sessões encontrados em ${sheetName}:`, data.length, 'registros');
                                            console.log('🔍 Primeira sessão:', data[0]);
                                            break;
                                        }
                                    }
                                } catch (parseError) {
                                    console.error(`❌ Erro JSON em ${sheetName}:`, parseError);
                                }
                            }
                        } else if (response.status === 400) {
                            console.warn(`⚠️ Sheet ${sheetName} não existe (400)`);
                        } else {
                            console.warn(`⚠️ Erro ${response.status} para ${sheetName}`);
                        }
                    } catch (sheetError) {
                        console.error(`❌ Erro de rede para ${sheetName}:`, sheetError.message);
                    }
                    
                    // Small delay between requests
                    await new Promise(resolve => setTimeout(resolve, 100));
                }
                
                // Process data if found
                if (data && data.length > 0) {
                    console.log(`🎉 Processando ${data.length} sessões do sheet ${successfulSheet}`);
                    console.log('📋 Colunas disponíveis:', Object.keys(data[0]));
                    
                    // Filter data based on user permissions and date/time
                    const currentDateTime = new Date();
                    const isMaster = isMasterUser();
                    let filteredData;
                    
                    if (isMaster) {
                        // Master sees ALL sessions without any filters (including future ones)
                        filteredData = data;
                        console.log(`👑 MASTER USER DETECTADO - Mostrando TODAS as ${filteredData.length} sessões (SEM FILTROS de data ou fisioterapeuta)`);
                    } else {
                        // Regular users see only their past sessions
                        const currentUserName = getCurrentUserName();
                        filteredData = data.filter(session => {
                            // First filter by date/time (only past sessions)
                            const sessionDate = session.data || session.date || '';
                            const sessionTime = session.horasessao || session.hora || session.time || '';
                            
                            if (sessionDate && sessionTime) {
                                const sessionDateTime = parseDateTime(sessionDate, sessionTime);
                                if (sessionDateTime && sessionDateTime > currentDateTime) {
                                    return false; // Skip future sessions
                                }
                            }
                            
                            // Then filter by user permissions
                            const physiotherapist = session.fisioterapeuta || session.physiotherapist || session.terapeuta || session.therapist || '';
                            return physiotherapist.toLowerCase().includes(currentUserName.toLowerCase());
                        });
                        console.log(`🔒 Utilizador normal - Dados filtrados: ${filteredData.length} sessões`);
                    }
                    
                    completedSessionsContainer.innerHTML = '';
                    filteredData.forEach((session, index) => {
                        // Use the correct field names from your sessoes sheet
                        const patientName = session.nome || 'Paciente não informado';
                        const sessionDate = session.data || 'Data não informada';
                        const sessionTime = session.horasessao || 'Hora não informada';
                        const sessionNumber = session.numerosessao || 'N/A';
                        const sessionStatus = session.estadosessao || 'Status não informado';
                        const isClosed = session.fechada || 'N/A';
                        
                        console.log(`📋 Sessão ${index + 1}: ${patientName} - ${sessionDate} às ${sessionTime}`);
                        console.log(`   Status: ${sessionStatus}, Fechada: ${isClosed}, Número: ${sessionNumber}`);
                        
                        // Get service and physiotherapist information using correct field names
                        const serviceName = session.servico || 'Serviço não informado';
                        const physiotherapist = session.fisioterapeuta || 'Fisioterapeuta não informado';
                        const businessName = session.negocio || '';
                        const county = session.concelho || '';
                        const phone = session.telefone || '';
                        const validation = session.validacao || '';
                        
                        const sessionElement = document.createElement('div');
                        sessionElement.className = 'flex items-center gap-4 rounded-lg bg-card-light dark:bg-card-dark p-3 shadow-sm border border-gray-200 dark:border-gray-700';
                        
                        sessionElement.innerHTML = `
                            <div class="flex h-12 w-12 shrink-0 items-center justify-center rounded-lg bg-purple-100 dark:bg-purple-900/50 text-purple-600 dark:text-purple-400">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24">
                                    <path d="M9 12.75L11.25 15 15 9.75M21 12a9 9 0 11-18 0 9 9 0 0118 0z" stroke-linecap="round" stroke-linejoin="round"></path>
                                </svg>
                            </div>
                            <div class="flex-1">
                                <p class="font-semibold text-primary dark:text-white">${patientName} - ${sessionDate}</p>
                                <p class="text-sm text-secondary dark:text-gray-400">${serviceName}</p>
                                <p class="text-xs text-purple-600 dark:text-purple-400">Fisioterapeuta: ${physiotherapist}</p>
                            </div>
                        `;
                        completedSessionsContainer.appendChild(sessionElement);
                    });
                    completedSessionsCount.textContent = `(${filteredData.length})`;
                } else {
                    console.log('📝 Nenhum dado válido de sessões encontrado, usando dados de exemplo');
                    loadCompletedSessionsFromFallback();
                }
                
            } catch (error) {
                console.error('❌ Erro geral ao carregar sessões:', error);
                loadCompletedSessionsFromFallback();
            }
        }

        function loadCompletedSessionsFromFallback() {
            const fallbackData = [
                {
                    paciente: "Carlos Pereira",
                    data: "2024-01-15",
                    servico: "Fisioterapia Ortopédica",
                    fisioterapeuta: "Dr. Carlos Mendes"
                },
                {
                    paciente: "Ana Costa",
                    data: "2024-01-14",
                    servico: "Fisioterapia Neurológica",
                    fisioterapeuta: "Dra. Ana Pereira"
                },
                {
                    paciente: "Luis Ferreira",
                    data: "2024-01-13",
                    servico: "Reabilitação Cardíaca",
                    fisioterapeuta: "Dr. Luis Costa"
                },
                {
                    paciente: "Sofia Rodrigues",
                    data: "2024-01-12",
                    servico: "Fortalecimento Lombar",
                    fisioterapeuta: "Dra. Sofia Martins"
                }
            ];

            // Filter fallback data based on user permissions
            let filteredFallbackData = fallbackData;
            const isMaster = isMasterUser();
            
            if (isMaster) {
                // Master sees ALL fallback sessions
                filteredFallbackData = fallbackData;
                console.log(`👑 MASTER USER - Mostrando todas as ${filteredFallbackData.length} sessões de exemplo (sem filtros)`);
            } else {
                // Regular users see filtered sessions
                const currentUserName = getCurrentUserName();
                filteredFallbackData = fallbackData.filter(session => {
                    return session.fisioterapeuta.toLowerCase().includes(currentUserName.toLowerCase());
                });
                console.log(`🔒 Utilizador normal - Sessões de exemplo filtradas: ${filteredFallbackData.length}`);
            }

            const completedSessionsContainer = document.getElementById('completedSessions');
            const completedSessionsCount = document.getElementById('completedSessionsCount');
            
            completedSessionsContainer.innerHTML = '';
            filteredFallbackData.forEach(session => {
                const sessionElement = document.createElement('div');
                sessionElement.className = 'flex items-center gap-4 rounded-lg bg-card-light dark:bg-card-dark p-3 shadow-sm border border-gray-200 dark:border-gray-700';
                sessionElement.innerHTML = `
                    <div class="flex h-12 w-12 shrink-0 items-center justify-center rounded-lg bg-purple-100 dark:bg-purple-900/50 text-purple-600 dark:text-purple-400">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24">
                            <path d="M9 12.75L11.25 15 15 9.75M21 12a9 9 0 11-18 0 9 9 0 0118 0z" stroke-linecap="round" stroke-linejoin="round"></path>
                        </svg>
                    </div>
                    <div class="flex-1">
                        <p class="font-semibold text-primary dark:text-white">${session.paciente} - ${session.data}</p>
                        <p class="text-sm text-secondary dark:text-gray-400">${session.servico}</p>
                        <p class="text-xs text-purple-600 dark:text-purple-400">Fisioterapeuta: ${session.fisioterapeuta}</p>
                    </div>
                `;
                completedSessionsContainer.appendChild(sessionElement);
            });
            completedSessionsCount.textContent = `(${filteredFallbackData.length})`;
        }

        // Login authentication with Google Sheets
        async function authenticateUser(accessCode) {
            try {
                console.log('🔐 Iniciando autenticação...');
                console.log('🔑 Código inserido:', accessCode);
                
                const baseUrl = 'https://api.steinhq.com/v1/storages/68d29050affba40a62ffb0f6';
                
                // Try different possible sheet names for users
                const possibleUserSheets = ['utilizadores', 'users', 'usuarios', 'Sheet3', 'Planilha3', 'Users'];
                
                for (const sheetName of possibleUserSheets) {
                    try {
                        console.log(`🔍 Testando sheet de utilizadores: ${sheetName}`);
                        const url = `${baseUrl}/${sheetName}`;
                        
                        const response = await fetch(url, {
                            method: 'GET',
                            headers: {
                                'Accept': 'application/json'
                            }
                        });
                        
                        console.log(`📡 Status ${sheetName}: ${response.status}`);
                        
                        if (response.status === 200) {
                            const rawData = await response.text();
                            console.log(`📄 Dados recebidos de ${sheetName}:`, rawData.length, 'caracteres');
                            
                            if (rawData && rawData.trim() !== '') {
                                try {
                                    const users = JSON.parse(rawData);
                                    console.log(`📊 Utilizadores encontrados:`, users.length);
                                    
                                    if (Array.isArray(users) && users.length > 0) {
                                        // Check if user exists with this access code
                                        const user = users.find(u => {
                                            const userCode = u.codigo || u.code || u.access_code || u.accesscode || u.password || u.senha;
                                            return userCode && userCode.toString().trim() === accessCode.trim();
                                        });
                                        
                                        if (user) {
                                            console.log('✅ Utilizador encontrado:', user);
                                            
                                            // Get user info
                                            const userName = user.nome || user.name || user.usuario || user.user || 'Utilizador';
                                            const userType = user.tipo || user.type || user.role || user.nivel || 'Utilizador';
                                            const userEmail = user.email || user.mail || '';
                                            const userSpecialty = user.especialidade || user.specialty || user.speciality || user.area || '';
                                            
                                            // Store user info
                                            sessionStorage.setItem('currentUser', JSON.stringify({
                                                name: userName,
                                                type: userType,
                                                email: userEmail,
                                                specialty: userSpecialty,
                                                code: accessCode
                                            }));
                                            
                                            // Update UI with user info
                                            updateUserInterface(userName, userType, userSpecialty);
                                            
                                            return { success: true, user: { name: userName, type: userType, email: userEmail, specialty: userSpecialty } };
                                        }
                                    }
                                } catch (parseError) {
                                    console.error(`❌ Erro JSON em ${sheetName}:`, parseError);
                                }
                            }
                        } else if (response.status === 400) {
                            console.warn(`⚠️ Sheet ${sheetName} não existe (400)`);
                        }
                    } catch (sheetError) {
                        console.error(`❌ Erro de rede para ${sheetName}:`, sheetError.message);
                    }
                    
                    // Small delay between requests
                    await new Promise(resolve => setTimeout(resolve, 100));
                }
                
                console.log('❌ Utilizador não encontrado em nenhuma sheet');
                return { success: false, error: 'Código de acesso inválido' };
                
            } catch (error) {
                console.error('❌ Erro geral na autenticação:', error);
                return { success: false, error: 'Erro de conexão. Tente novamente.' };
            }
        }

        function updateUserInterface(userName, userType, userSpecialty) {
            console.log(`🔧 Atualizando interface para: ${userName}, Tipo: ${userType}, Especialidade: ${userSpecialty}`);
            
            // Update header user info
            document.getElementById('headerUserName').textContent = userName;
            // Show specialty if available, otherwise show user type
            document.getElementById('headerUserType').textContent = userSpecialty || userType;
            
            // Update side menu user info
            document.getElementById('sideMenuUserName').textContent = userName;
            // Show specialty if available, otherwise show user type
            document.getElementById('sideMenuUserType').textContent = userSpecialty || userType;
            
            // Update user initials
            const initials = userName.split(' ').map(n => n[0]).join('').toUpperCase().substring(0, 2);
            document.getElementById('headerUserInitials').textContent = initials;
            document.getElementById('sideMenuUserInitials').textContent = initials;
            
            // Show/hide user management based on specialty or user type
            const userManagementItem = document.getElementById('userManagementMenuItem');
            const isMasterOrAdmin = userSpecialty.toLowerCase().includes('master') || userType.toLowerCase().includes('master') || userType.toLowerCase().includes('admin');
            console.log(`🔧 É master/admin? ${isMasterOrAdmin} (especialidade: "${userSpecialty}", tipo: "${userType}")`);
            
            if (isMasterOrAdmin) {
                userManagementItem.style.display = 'block';
                console.log(`👑 Menu de gestão de utilizadores ATIVADO para ${userName} (especialidade: ${userSpecialty})`);
            } else {
                userManagementItem.style.display = 'none';
                console.log(`🔒 Menu de gestão de utilizadores DESATIVADO para ${userName} (especialidade: ${userSpecialty})`);
            }
        }

        // Login form handling
        document.getElementById('loginForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const loginButton = document.getElementById('loginButton');
            const loginText = document.getElementById('loginText');
            const loginLoading = document.getElementById('loginLoading');
            const loginError = document.getElementById('loginError');
            const errorMessage = document.getElementById('errorMessage');
            const accessCode = document.getElementById('accessCode').value;
            
            // Hide previous errors
            loginError.style.display = 'none';
            
            // Show loading state
            loginText.style.display = 'none';
            loginLoading.style.display = 'inline-block';
            loginButton.disabled = true;
            
            try {
                // Authenticate with Google Sheets
                const authResult = await authenticateUser(accessCode);
                
                if (authResult.success) {
                    // Success - switch to main app
                    document.getElementById('loginPage').classList.remove('active');
                    document.getElementById('mainApp').classList.add('active');
                    
                    // Load data from Steinhq after successful login
                    setTimeout(() => {
                        loadActivePlans();
                        loadCompletedSessions();
                    }, 500);
                } else {
                    // Show error
                    errorMessage.textContent = authResult.error;
                    loginError.style.display = 'block';
                }
            } catch (error) {
                console.error('❌ Erro no login:', error);
                errorMessage.textContent = 'Erro de conexão. Verifique sua internet e tente novamente.';
                loginError.style.display = 'block';
            }
            
            // Reset button state
            loginText.style.display = 'inline';
            loginLoading.style.display = 'none';
            loginButton.disabled = false;
        });
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9853a4f626248c92',t:'MTc1ODg5ODk2OC4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
